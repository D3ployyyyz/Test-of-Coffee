<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Omegle Clone</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&family=Indie+Flower&display=swap');

    body {
      font-family: 'Outfit', sans-serif;
      background: #f6f1e7;
      color: #4b3e36;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-container {
      max-width: 720px;
      margin: auto;
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 24px;
      box-sizing: border-box;
    }

    #video-chat {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 16px;
    }

    #video-chat video {
      width: 160px;
      border-radius: 12px;
      background: #000;
    }

    #start-video {
      align-self: center;
      margin-bottom: 12px;
      padding: 8px 16px;
      font-weight: bold;
      background-color: #c8a88e;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    #chat-log {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fffaf4;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow: inset 0 0 6px #e2d2c5;
      scrollbar-width: thin;
      scrollbar-color: #c1b2a2 transparent;
    }

    #chat-log::-webkit-scrollbar {
      width: 8px;
    }

    #chat-log::-webkit-scrollbar-thumb {
      background-color: #c1b2a2;
      border-radius: 6px;
    }

    .message {
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 24px;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.5;
      animation: fadeIn 0.4s ease;
    }

    .mine {
      background: #c9efd7;
      color: #2d4635;
      align-self: flex-end;
      border-bottom-right-radius: 8px;
    }

    .theirs {
      background: #f2e2d2;
      color: #4b3e36;
      align-self: flex-start;
      border-bottom-left-radius: 8px;
    }

    #typing-indicator {
      font-style: italic;
      color: #9c8f80;
      height: 22px;
      padding-left: 12px;
      margin-top: 6px;
      font-size: 14px;
      font-family: 'Indie Flower', cursive;
    }

    .input-area {
      display: flex;
      margin-top: 16px;
      align-items: center;
      gap: 10px;
      background: #fffaf4;
      padding: 12px 16px;
      border-radius: 20px;
      box-shadow: 0 0 8px rgba(200, 180, 160, 0.2);
    }

    #file-input {
      cursor: pointer;
      background: transparent;
      color: #a58d78;
      border: none;
      font-size: 15px;
    }

    #chat-message-input {
      flex-grow: 1;
      padding: 12px 16px;
      border-radius: 24px;
      border: none;
      font-size: 15px;
      outline: none;
      background: #f2e7da;
      color: #3d332a;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }

    #chat-message-input:focus {
      background: #f7ece0;
    }

    #send-button {
      padding: 10px 20px;
      background: #c8a88e;
      border: none;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
    }

    #send-button:hover {
      background-color: #b89378;
    }

    .message img,
    .message video,
    .message audio {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 6px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<div>
  <h3>Você está conversando com:</h3>
  {% if partner_user %}
    <p>Nome: {{ partner_user.nome }}</p>
    {% if partner_user.foto %}
      <img src="{{ partner_user.foto }}" alt="Foto de {{ partner_user.nome }}" width="100" />
    {% endif %}
    <p>Descrição: {{ partner_user.descricao }}</p>
  {% else %}
    <p>Parceiro não encontrado.</p>
  {% endif %}
</div>

<div class="chat-container">
  <div id="video-chat">
    <video id="localVideo" autoplay muted playsinline style="display:none;"></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <button id="start-video">Ativar Minha Câmera</button>
  <div id="chat-log"></div>
  <div id="typing-indicator"></div>
  <div class="input-area">
    <input type="file" id="file-input" accept="image/*,audio/*,video/*" />
    <input id="chat-message-input" type="text" autocomplete="off" placeholder="Digite sua mensagem..." />
    <button id="send-button">Enviar</button>
  </div>
</div>

<script>
  const myUserId = {{ usuario_logado.id }};
  const roomId = "{{ room.id }}";
  const wsScheme = location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${wsScheme}://${location.host}/ws/chat/${roomId}/`);

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const startVideoBtn = document.getElementById("start-video");

  let localStream = null;
  let peerConnection = null;
  const config = { 
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
    sdpSemantics: 'unified-plan'
  };

  function createPeerConnection() {
    if (peerConnection) return;
    peerConnection = new RTCPeerConnection(config);

    peerConnection.onicecandidate = ({ candidate }) => {
      if (candidate) socket.send(JSON.stringify({ type: "ice-candidate", candidate }));
    };

    peerConnection.ontrack = (event) => {
      if (event.streams && event.streams[0]) remoteVideo.srcObject = event.streams[0];
    };

    // Garante m-line em todos os navegadores
    const videoDir = localStream ? 'sendrecv' : 'recvonly';
    const audioDir = localStream ? 'sendrecv' : 'recvonly';
    peerConnection.addTransceiver('video', { direction: videoDir });
    peerConnection.addTransceiver('audio', { direction: audioDir });
  }

  async function startCameraAndSendOffer() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.style.display = "block";
      localVideo.srcObject = localStream;
    } catch (e) {
      alert("Erro ao acessar câmera: " + e.message);
      return;
    }

    // Re-cria PC para usar sendrecv
    peerConnection = null;
    createPeerConnection();

    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: "video-offer", offer }));
  }

  async function handleVideoOffer(offer) {
    peerConnection = null;
    createPeerConnection();

    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

    // Se quiser enviar vídeo posteriormente, tracks serão adicionadas aqui
    if (localStream) localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.send(JSON.stringify({ type: "video-answer", answer }));
  }

  async function handleVideoAnswer(answer) {
    if (!peerConnection) return;
    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
  }

  async function handleNewICECandidate(candidate) {
    if (!peerConnection) return;
    try {
      await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    } catch (e) {
      console.error("Erro ao adicionar ICE candidate:", e);
    }
  }

  startVideoBtn.onclick = () => {
    startVideoBtn.disabled = true;
    startVideoBtn.textContent = "Câmera Ativada";
    startCameraAndSendOffer();
  };

  socket.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);
    switch (msg.type) {
      case "video-offer": return handleVideoOffer(msg.offer);
      case "video-answer": return handleVideoAnswer(msg.answer);
      case "ice-candidate": return handleNewICECandidate(msg.candidate);
      case "typing":
        typingIndicator.textContent = "O estranho está digitando...";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingIndicator.textContent = '', 2000);
        break;
      case "message": appendMessage(msg.message, msg.sender); break;
      case "media": appendMedia(msg); break;
      case "room_closed":
        fetch('/leave/', { method: 'GET', credentials: 'same-origin' })
          .finally(() => location.href = '/');
        break;
    }
  };

  // Chat comum
  const chatLog = document.getElementById("chat-log");
  const typingIndicator = document.getElementById("typing-indicator");
  const input = document.getElementById("chat-message-input");
  const sendBtn = document.getElementById("send-button");
  const fileInput = document.getElementById("file-input");
  let typingTimeout;

  input.addEventListener("input", () => {
    socket.send(JSON.stringify({ type: "typing" }));
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => typingIndicator.textContent = '', 2000);
  });

  sendBtn.onclick = () => {
    const msg = input.value.trim();
    if (!msg) return;
    socket.send(JSON.stringify({ type: "message", message: msg }));
    input.value = '';
  };

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault(); sendBtn.click();
    }
  });

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => socket.send(JSON.stringify({ type: "media", filename: file.name, content_type: file.type, data: reader.result }));
    reader.readAsDataURL(file);
    fileInput.value = '';
  });

  function appendMessage(text, mine) {
    const d = document.createElement("div");
    d.classList.add("message", mine ? "mine" : "theirs");
    d.textContent = text; chatLog.appendChild(d); chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendMedia(d) {
    const c = document.createElement("div");
    c.classList.add("message", d.sender_id === myUserId ? "mine" : "theirs");
    if (d.content_type.startsWith("image/")) { const img = document.createElement("img"); img.src = d.data; c.appendChild(img); }
    else if (d.content_type.startsWith("audio/")) { const a = document.createElement("audio"); a.controls=true; a.src=d.data; c.appendChild(a); }
    else if (d.content_type.startsWith("video/")) { const v = document.createElement("video"); v.controls=true; v.src=d.data; c.appendChild(v); }
    else { c.textContent = "Arquivo: " + d.filename; }
    chatLog.appendChild(c); chatLog.scrollTop = chatLog.scrollHeight;
  }
</script>
