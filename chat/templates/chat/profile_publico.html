{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TANOTO ‚Äî Perfil Aconchegante</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&family=Indie+Flower&family=VT323&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'chat/style_.css' %}">

  <style>
    /* Reset b√°sico */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background: #fefcf8;
      overflow-x: hidden;
    }

    .container {
  transform: scale(0.9);
  transform-origin: top center;
  margin-left: auto;
  margin-right: auto;
}


    /* Sidebar */
    .lofi-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 162px;
      height: 100vh;
      background: rgba(140, 115, 165, 0.2); /* roxo suave transl√∫cido */
      backdrop-filter: blur(4px); /* opcional: vidro fosco */
      border-right: 2px solid #e2cfc3;
      padding-top: 4rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
      z-index: 99;

      /* Para anima√ß√£o de esconder */
      transform: translateX(0);
      transition: transform 0.3s ease;
    }
    .lofi-sidebar.hidden {
      transform: translateX(-180px);
    }

    /* Bot√£o bookmark que puxa a sidebar */
    #toggle-sidebar {
      position: fixed;
      top: 15px;
      left: 162px; /* inicial √† direita da sidebar */
      width: 40px;
      height: 40px;
      background: #f5e8db;
      border: 2px solid #e2cfc3;
      border-radius: 6px 0 0 6px;
      cursor: pointer;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: left 0.3s ease, background 0.3s ease;
      user-select: none;
    }
    /* √çcone bookmark simples */
    #toggle-sidebar::before {
      content: "üîñ";
      font-size: 22px;
      line-height: 1;
    }
    /* Quando sidebar estiver escondida, bot√£o pula para a esquerda da tela */
    .lofi-sidebar.hidden + #toggle-sidebar {
      left: 0;
      border-radius: 0 6px 6px 0;
      background: #fefcf8;
    }

    /* Lista da sidebar */
    .lofi-sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      align-items: flex-start;
      padding-left: 1rem;
    }

    .lofi-sidebar nav ul li a {
      display: flex;
      align-items: flex-start; /* alinha o conte√∫do ao topo */
      gap: 0.8rem;
      padding: 6px 12px;
      border-radius: 12px;
      transition: background 0.2s ease, transform 0.2s ease;
      color: #6b4f3f;
      font-family: 'Outfit', sans-serif;
      font-size: 0.855rem;
      font-weight: 500;
    }

    .lofi-sidebar nav ul li a img {
      width: 20px;
      height: 20px;
      filter: sepia(40%) brightness(90%);
      /* mant√©m o √≠cone alinhado no topo */
    }

    .lofi-sidebar nav ul li a span {
      display: inline-block;
      margin-top: 3px; /* desloca o texto um pouco pra baixo */
      width: auto;
    }

    .lofi-sidebar nav ul li a:hover {
      background: rgba(149, 115, 179, 0.15); /* lavanda bem suave */
      transform: translateX(4px);
    }

    .profile-right-column {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem; /* espa√ßamento entre elementos */
    }

    .edit-button {
      width: auto;
      margin-left: 210px;
      background: #ffe8cc;
      color: #5d4037;
      font-size: .8rem;
      padding: 0.1rem 1.3rem;
      border: 2px solid #e6c8ac;
      border-radius: 16px;
      text-decoration: none;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }

    .edit-button_ {
      background: #ffe8c800;
      color: #5d4037;
      font-size: .8rem;
      border: 2px solid #e6c8a800;
      border-radius: 16px;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .edit-button:hover {
      background: #ffdbb0;
      transform: translateY(-2px);
      box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.08);
    }

    /* Capa quadrada da playlist */
    .playlist-cover-img {
      width: 155px;       /* largura fixa */
      max-height: 155px;      /* altura fixa igual √† largura para ser quadrada */
      object-fit: cover;  /* cortar mantendo propor√ß√£o */
      border-radius: 8px; /* cantos arredondados opcionais */
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      cursor: pointer;    /* se quiser indicar que √© clic√°vel */
    }

    .vinyl-label {
      position: relative;
      width: 42px;
      height: 42px;
      border-radius: 100%;
      overflow: visible; /* permite que o c√≠rculo fique maior sem cortar */
    }

.vinyl-background {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 47px;     /* maior que o vinil */
  height: 47px;
  background-color: white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  z-index: 0;
  box-shadow: 0 0 8px rgba(0,0,0,0.15);
}

#vinyl-label-img {
  position: relative;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  z-index: 1;
  display: block;
}

  </style>
</head>
<body>

  <aside class="lofi-sidebar" id="sidebar">
    <nav>
      <ul>
        <div>TANOTO</div>
        <li>
          <a href="{% url 'chat:home' %}">
            <img src="https://cdn-icons-png.flaticon.com/128/1946/1946488.png" alt=""> 
            <span>Home</span>
          </a>
        </li>
        <li>
          <a href="{% url 'chat:profile' %}">
            <img src="https://cdn-icons-png.flaticon.com/128/747/747376.png" alt=""> 
            <span>Meu Perfil</span>
          </a>
        </li>
        <li>
          <a href="{% url 'chat:home' %}">
            <img src="https://cdn-icons-png.flaticon.com/128/2589/2589175.png" alt=""> 
            <span>Chat</span>
          </a>
        </li>
        <li>
          <a href="{% url 'chat:clubes_lista' %}">
            <img src="https://cdn-icons-png.flaticon.com/128/1042/1042333.png" alt=""> 
            <span>Salas</span>
          </a>
        </li>
        <li>
          <a href="#">
            <img src="https://cdn-icons-png.flaticon.com/128/54/54481.png" alt=""> 
            <span>Explorar</span>
          </a>
        </li>
        <li>
          <a href="#">
            <img src="https://cdn-icons-png.flaticon.com/128/857/857681.png" alt=""> 
            <span>Invent√°rio</span>
          </a>
        </li>
      </ul>      
    </nav>
  </aside>
  
  <button style="margin-top: 60px;" id="toggle-sidebar" aria-label="Toggle sidebar"></button>
  
  <!-- GIFs decorativos lo-fi -->
  <div class="ambient-gifs">
    <img src="https://media.tenor.com/ipuTozw3PXsAAAAj/pixel-cat.gif" class="ambient-gif cat" alt="gatinho pixel">
    <img src="https://i.pinimg.com/originals/1a/56/ea/1a56eaaaf78869d7c6e0e620b2b98394.gif" class="ambient-gif coffee" alt="caf√© quentinho">
    <img src="https://img1.picmix.com/output/stamp/thumb/8/6/4/7/1007468_b04a4.gif" class="ambient-gif leaves" alt="folhas caindo">
  </div>  
  
  <div class="container">
  
    <!-- PERFIL -->
    <div id="profile">
      <div class="left-profile">
        {% if usuario.foto %}
          <img class="pic" src="{{ usuario.foto }}" alt="Foto de perfil">
        {% endif %}
        <div class="badges">
          <div class="badge">üèÖ</div>
          <div class="badge">üèÖ</div>
          <div class="badge">üèÖ</div>
          <div class="badge">üèÖ</div>
        </div>
      </div>
  
      <div class="content">
        <div class="header-info">
          <div class="emotion">{{ usuario.emoji }}</div>
          <div class="name">{{ usuario.nome }}</div>
          <div class="meta">
            Desde {{ usuario.criado_em|date:"d/m/Y" }}
          </div>
          <div class="meta">
            ‚òï {{ usuario.dias_consecutivos }} caf√©s
          </div>          
        </div>
        <div class="description">{{ usuario.descricao }}</div>
        <div class="location">{{ usuario.localizacao }}</div>
        <div class="likes">
          {% for gosto in usuario.gostos %}
            <span class="like-item">{{ gosto }}</span>
          {% endfor %}
        </div> 
        <div class="socials">
          {% for social in usuario.redes_sociais %}
            <a href="{{ social.url }}" target="_blank" rel="noopener noreferrer">
              <img src="{% static 'icons/default.png' %}" alt="social icon"
                   data-url="{{ social.url }}" class="social-icon" />
            </a>          
          {% endfor %}
        </div>
      </div>
  
      <div class="profile-right-column">
        <div class="playlist-cover">
          <!-- disco e capa da playlist -->
          <div class="vinyl-disc">
            <div class="vinyl-grooves"></div>
            <div class="vinyl-label">
              <div class="vinyl-background"></div>
              <img id="vinyl-label-img" src="" alt="Label"/>
            </div>
          </div>
          <div id="playlist-image-container">
            <!-- JS insere capa e iframe -->
          </div>
        </div>
        <!-- BOT√ÉO ADICIONAR AMIGO -->
          <form action="{% url 'chat:adicionar_amigo' usuario.id %}" method="post" >
            {% csrf_token %}
            {% if ja_amigo %}
              <button class="edit-button" type="submit" >Remover Amigo</button>
            {% else %}
              <button class="edit-button" type="submit" >Adicionar Amigo</button>
            {% endif %}
          </form>


        {# Link ‚ÄúChat‚Äù que leva √† Conversation #}
        {% if ja_amigo %}
          <a class="edit-button"
            href="{% url 'chat:conversation' conv_id %}">
            üí¨ Chat
          </a>
        {% endif %}

        {% if usuario_logado != usuario %}
          {% if usuario in usuario_logado.bloqueados.all %}
            <form method="post" action="{% url 'chat:desbloquear_usuario' usuario.id %}">
                {% csrf_token %}
                <button type="submit">üîì Desbloquear</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'chat:bloquear_usuario' usuario.id %}">
                {% csrf_token %}
                <button type="submit">üîí Bloquear</button>
            </form>
          {% endif %}
        {% endif %}


      </div>
    </div>
  
    <!-- MURAL & LISTAS -->
    <div class="below-profile">
       <div id="mural" style="position: relative;">
          <form id="form-recado" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="autor" value="{{ usuario_logado.nome }}">
            <input type="hidden" name="foto" value="{{ usuario_logado.foto|default:'https://i.pravatar.cc/44' }}">
            <input type="text" name="texto" placeholder="Escreva seu recado..." required maxlength="150" />
            <input type="text" name="reacoes" placeholder="Rea√ß√µes (ex: üíñ üòå ‚òï)" maxlength="20" />
            <button type="submit">Adicionar</button>
          </form>

       {% for recado in recados %}
        <article class="recado"
                data-id="{{ recado.id }}"
                style="position: absolute; left: {{ recado.left }}px; top: {{ recado.top }}px; z-index: {{ recado.z_index }};">

          <div class="autor">
            <img class="avatar" src="{{ recado.foto }}" alt="avatar {{ recado.autor }}" />
            <strong>{{ recado.autor }}</strong>
            
            {% if recado.autor == usuario_logado.nome %}
              <button class="excluir-recado" data-id="{{ recado.id }}">üóëÔ∏è</button>
            {% endif %}
          </div>

          <p class="texto">{{ recado.texto }}</p>

          <div class="footer">
            <span class="data">{{ recado.data|date:"d/m" }}</span>
            <span class="reacoes">{{ recado.reacoes }}</span>
          </div>
          
        </article>
      {% endfor %}


        </div>

  
      <div id="lists">
        <div class="list">
          <h3>Amigos</h3>
          <div class="list-items">
            <div class="list-item">
              <img class="friend-avatar" src="https://i.pravatar.cc/60?img=1"/>
              <div class="tooltip">Gato404<br>Amante de pixel art e caf√© ‚òï</div>
              <div>Gato404</div>
            </div>
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=2" />
              <div>BunnyMix</div>
            </div>
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=3" />
              <div>Foxy</div>
            </div>
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=4" />
              <div>Tartaruga</div>
            </div>
            <!-- ... repita outros amigos ... -->
          </div>
        </div>
  
        <div class="list">
          <h3>Clubes</h3>
          <div class="list-items">
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=5" />
              <div>Retro Gamers</div>
            </div>
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=6" />
              <div>Lo-fi Fans</div>
            </div>
            <div class="list-item">
              <img src="https://i.pravatar.cc/60?img=7" />
              <div>VHS Club</div>
            </div>
            <!-- ... repita outros clubes ... -->
          </div>
        </div>
      </div>
    </div>
  </div>
  


  <script src="{% static 'chat/_profile.js' %}"></script>

<script>
  // 1) √çcones de redes sociais
  const iconMap = [
    { domain: 'youtube.com', icon: 'https://cdn-icons-png.flaticon.com/128/1384/1384028.png' },
    { domain: 'instagram.com', icon: 'https://cdn-icons-png.flaticon.com/128/1384/1384031.png' },
    { domain: 'x.com', icon: 'https://cdn-icons-png.flaticon.com/128/5968/5968958.png' },
    { domain: 'linkedin.com', icon: 'https://cdn-icons-png.flaticon.com/128/1384/1384014.png' },
    { domain: 'facebook.com', icon: 'https://cdn-icons-png.flaticon.com/128/1384/1384028.png' },
    { domain: 'tiktok.com', icon: 'https://cdn-icons-png.flaticon.com/128/3046/3046120.png' }
  ];

  function getIconForUrl(url) {
    try {
      const hostname = new URL(url).hostname.replace('www.', '');
      const match = iconMap.find(site => hostname.includes(site.domain));
      return match ? match.icon : 'https://cdn-icons-png.flaticon.com/128/565/565547.png';
    } catch {
      return 'https://cdn-icons-png.flaticon.com/128/565/565547.png';
    }
  }

  document.querySelectorAll('.social-icon').forEach(img => {
    const url = img.dataset.url;
    img.src = getIconForUrl(url);
  });
</script>

<script>
  // 2) Carrega capa e iframe da playlist, se existir
  (function(){
    const playlistUrl = "{{ usuario.playlist|default:'' }}";
    if (playlistUrl) {
      loadPlaylistCover(playlistUrl);
    }
  })();
</script>

<script>
  (function(){
    const form      = document.getElementById('form-recado');
    const mural     = document.getElementById('mural');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let dragging = null, offsetX = 0, offsetY = 0;

    function bringToFront(el) {
      const all = Array.from(document.querySelectorAll('.recado'));
      const maxZ = all.length
        ? Math.max(...all.map(r => parseInt(r.style.zIndex) || 1))
        : 1;
      el.style.zIndex = maxZ + 1;
      return el.style.zIndex;
    }

    function enableDrag(rec) {
      rec.addEventListener('mousedown', e => {
        dragging = rec;
        offsetX = e.clientX - rec.offsetLeft;
        offsetY = e.clientY - rec.offsetTop;
        bringToFront(rec);
        e.preventDefault();
      });

      rec.addEventListener('click', async e => {
        const newZ = bringToFront(rec);
        const id = rec.dataset.id;
        if (!id) return;
        try {
          await fetch("{% url 'chat:mover_recado' 0 %}".replace('0', id), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              left: parseInt(rec.style.left),
              top: parseInt(rec.style.top),
              z_index: parseInt(newZ)
            })
          });
        } catch (err) {
          console.error('Erro ao atualizar z-index:', err);
        }
        e.stopPropagation();
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const autor   = form.autor.value;
      const foto    = form.foto.value;
      const texto   = form.texto.value.trim();
      const reacoes = form.reacoes.value.trim();
      if (!autor || !texto) return;

      const left = Math.floor(10 + Math.random() * (mural.clientWidth - 140));
      const top  = Math.floor(60 + Math.random() * (mural.clientHeight - 170));

      try {
        const res = await fetch("{% url 'chat:enviar_recado' usuario.id %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ autor, foto, texto, reacoes, left, top })
        });
        const data = await res.json();
        if (data.status === 'ok') {
          const r = data.recado;
          const a = document.createElement('article');
          a.className = 'recado';
          a.dataset.id = r.id;
          a.style.cssText = `position:absolute; left:${r.left}px; top:${r.top}px; z-index:${r.z_index || 10}`;
          a.innerHTML = `
            <div class="autor">
              <img class="avatar" src="${r.foto}" alt="avatar ${r.autor}" />
              <strong>${r.autor}</strong>
            </div>
            <p class="texto">${r.texto}</p>
            <div class="footer">
              <span class="data">${r.data}</span>
              <span class="reacoes">${r.reacoes}</span>
            </div>`;
          enableDrag(a);
          mural.appendChild(a);
          form.reset();
        } else {
          console.error('Erro ao adicionar recado:', data);
        }
      } catch (err) {
        console.error('Erro ao enviar recado:', err);
      }
    });

    document.querySelectorAll('.recado').forEach((r, i) => {
      r.style.position = 'absolute';
      r.style.zIndex = r.style.zIndex || (i + 1);
      enableDrag(r);
    });

    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      const rectElem  = dragging.getBoundingClientRect();
      const rectMural = mural.getBoundingClientRect();
      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;
      x = Math.max(0, Math.min(x, rectMural.width  - rectElem.width));
      y = Math.max(0, Math.min(y, rectMural.height - rectElem.height));
      dragging.style.left = `${x}px`;
      dragging.style.top  = `${y}px`;
    });

    document.addEventListener('mouseup', async () => {
      if (!dragging) return;
      const id = dragging.dataset.id;
      const left = parseInt(dragging.style.left, 10);
      const top  = parseInt(dragging.style.top, 10);
      const z_index = parseInt(dragging.style.zIndex, 10);
      try {
        await fetch("{% url 'chat:mover_recado' 0 %}".replace('0', id), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ left, top, z_index })
        });
      } catch (err) {
        console.error('Erro ao salvar posi√ß√£o:', err);
      }
      dragging = null;
    });
  })();
</script>

<script>
  document.querySelectorAll('.excluir-recado').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = btn.dataset.id;
     
        const resp = await fetch(`/excluir_recado/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          }
        });
        if (resp.ok) {
          document.querySelector(`article[data-id="${id}"]`).remove();
        } 
      
    });
  });
</script>





</body>
</html>
